angular.module("mwFormUtils",["mwFormUtils.responseUtils"]).constant("MW_QUESTION_TYPES_WITH_AUTOFILL",["text","textarea","number","date","time","email","range","url"]).service("mwAutofillService",function(){var e=[];this.addAutofillList=function(t){e=e.concat(t)},this.setAutofillList=function(t){e=t},this.clearAutofillList=function(){e=[]},this.getAutofillList=function(){return e};var t={};this.setAutofillSource=function(e){t=e},this.clearAutofillSource=function(){t={}},this.getAutofillSource=function(){return t}}),angular.module("mwFormUtils.responseUtils",[]).constant("MW_QUESTION_TYPES_WITH_DEFAULT_ANSWER",["text","textarea","number","date","time","email","range","url"]).factory("mwFormResponseUtils",["MW_QUESTION_TYPES_WITH_DEFAULT_ANSWER",function(e){var t={},r=e;return t.$getObjectByIdMap=function(e,t){var r={};return e?(e.forEach(function(e){var i=e;t&&(i=t(e)),r[e.id]=i}),r):r},t.$getOfferedAnswerByIdMap=function(e){return t.$getObjectByIdMap(e.offeredAnswers,function(e){return{id:e.id,value:e.value}})},t.$extractResponseForQuestionWithOfferedAnswers=function(e,r){var i=t.$getOfferedAnswerByIdMap(e),n={};return r.selectedAnswers?(n.selectedAnswers=[],r.selectedAnswers.forEach(function(e){n.selectedAnswers.push(i[e])})):r.selectedAnswer&&(n.selectedAnswer=i[r.selectedAnswer]),r.other&&(n.other=r.other),n},t.$extractResponseForPriorityQuestion=function(e,r){var i=[];if(!r.priorityList)return i;var n=t.$getObjectByIdMap(e.priorityList);return r.priorityList.forEach(function(e){var t=n[e.id];i.push({id:t.id,value:t.value,priority:e.priority})}),i},t.$extractResponseForDivisionQuestion=function(e,r){var i=[],n=t.$getObjectByIdMap(e.divisionList);return Object.getOwnPropertyNames(r).forEach(function(e){var t=r[e],o=n[e];o&&i.push({id:o.id,label:o.value,value:t})}),i},t.$extractResponseForGridQuestion=function(e,r){if(!e.grid||!e.grid.rows)return i;if("radio"==e.grid.cellInputType)return t.$extractResponseForRadioGridQuestion(e,r);var i=[];return e.grid.rows.forEach(function(t){e.grid.cols.forEach(function(e){var n={row:{id:t.id,label:t.label},col:{id:e.id,label:e.label},value:null};r.hasOwnProperty(t.id)&&r[t.id].hasOwnProperty(e.id)&&(n.value=r[t.id][e.id]),i.push(n)})}),i},t.$extractResponseForRadioGridQuestion=function(e,r){var i=[],n=t.$getObjectByIdMap(e.grid.cols);return e.grid.rows.forEach(function(e){var t=r[e.id],o=null;t&&(o=n[t]);var s={row:{id:e.id,label:e.label},col:null};o&&(s.col={id:o.id,label:o.label}),i.push(s)}),i},t.extractResponse=function(e,i){return r.indexOf(e.type)!==-1?i.answer:"radio"==e.type||"checkbox"==e.type||"select"==e.type?t.$extractResponseForQuestionWithOfferedAnswers(e,i):"grid"==e.type?t.$extractResponseForGridQuestion(e,i):"priority"==e.type?t.$extractResponseForPriorityQuestion(e,i):"division"==e.type?t.$extractResponseForDivisionQuestion(e,i):null},t.mergeFormWithResponse=function(e,r){var i={};return angular.copy(e,i),i.pages.forEach(function(e){e.elements.forEach(function(e){var i=e.question;if(i){var n=r[i.id];n&&(i.response=t.extractResponse(i,n))}})}),i},t.getQuestionList=function(e,t){var r=[];return e.pages.forEach(function(e){e.elements.forEach(function(e){if(e.question){var i=e.question;t&&(i={},angular.copy(e.question,i)),r.push(i)}})}),r},t.getQuestionWithResponseList=function(e,r){var i=[];return t.getQuestionList(e,!0).forEach(function(e){var n=r[e.id];n?e.response=t.extractResponse(e,n):e.response=null,i.push(e)}),i},t.$$getHeader=function(e,t,r,i,n){var o="";return n&&((e||0===e)&&(o+=e+"."),null!==r&&void 0!==r&&(Array.isArray(r)||(r=[r]),r.forEach(function(e){o+=e+"."})),o.length&&(o+=" ")),o+=t,null===i||void 0===i?o:(Array.isArray(i)||(i=[i]),i.forEach(function(e){o+=" ["+e+"]"}),o)},t.getResponseSheetHeaders=function(e,r){var i=["grid","priority","division"],n=[],o=0;return t.getQuestionList(e).forEach(function(e){o++;var s=1;if(i.indexOf(e.type)===-1)n.push(t.$$getHeader(o,e.text,null,null,r));else if("grid"==e.type){if(!e.grid)return;"radio"==e.grid.cellInputType?e.grid.rows.forEach(function(i){n.push(t.$$getHeader(o,e.text,s,i.label,r)),s++}):e.grid.rows.forEach(function(i,u){e.grid.cols.forEach(function(a,c){n.push(t.$$getHeader(o,e.text,[u+1,c+1],[i.label,a.label],r)),s++})})}else if("priority"==e.type){if(!e.priorityList)return;e.priorityList.forEach(function(i){n.push(t.$$getHeader(o,e.text,s,i.value,r)),s++})}else if("division"==e.type){if(!e.divisionList)return;e.divisionList.forEach(function(i){n.push(t.$$getHeader(o,e.text,s,i.value,r)),s++})}}),n},t.getResponseSheetRow=function(e,r){var i="; ",n=[];if(!r)return n;for(var o=t.getQuestionWithResponseList(e,r),s=["radio","checkbox","select","grid","priority","division"],u=0;u<o.length;u++){var a=o[u],c=a.response;if(s.indexOf(a.type)!==-1){if("radio"==a.type||"select"==a.type){if(!c){n.push("");continue}var l="";c.selectedAnswer&&(l=c.selectedAnswer.value),c.other&&(l&&(l+=i),l+=c.other),n.push(l)}else if("checkbox"==a.type){if(!c||!c.selectedAnswers){n.push("");continue}var l="";c.selectedAnswers.forEach(function(e){l&&(l+=i),l+=e.value}),c.other&&(l&&(l+=i),l+=c.other),n.push(l)}else if("grid"==a.type){if(!a.grid)continue;if(!c){"radio"==a.grid.cellInputType?a.grid.rows.forEach(function(){n.push("")}):a.grid.rows.forEach(function(){a.grid.cols.forEach(function(){n.push("")})});continue}"radio"==a.grid.cellInputType?c.forEach(function(e){n.push(e.col?e.col.label:"")}):c.forEach(function(e){n.push(e.value)})}else if("priority"==a.type){if(!a.priorityList)continue;var f=t.$getObjectByIdMap(c);a.priorityList.forEach(function(e){var t=f[e.id];t?n.push(t.priority):n.push("")})}else if("division"==a.type){if(!a.divisionList)continue;var p=t.$getObjectByIdMap(c);a.divisionList.forEach(function(e){var t=p[e.id];t?n.push(t.value):n.push("")})}}else n.push(c?c:"")}return n},t.getResponseSheetRows=function(e,r){return r.map(function(r){return t.getResponseSheetRow(e,r)})},t.getResponseSheet=function(e,r,i){var n=[],o=t.getResponseSheetHeaders(e,i);return n.push(o),r?(r instanceof Array?r.forEach(function(r){n.push(t.getResponseSheetRow(e,r))}):n.push(t.getResponseSheetRow(e,r)),n):n},t}]);